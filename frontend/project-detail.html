<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - TheBinary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/modern-theme.css">
    <link rel="stylesheet" href="css/space-background.css">
    <link rel="stylesheet" href="css/bootstrap-custom.css">
    <link rel="stylesheet" href="css/homepage-layout.css">
    <link rel="stylesheet" href="css/projects-layout.css">
    <link rel="stylesheet" href="css/reviews.css">
    <link rel="stylesheet" href="css/project-showcase.css">
    <link rel="stylesheet" href="css/project-gallery.css">
    <link rel="stylesheet" href="css/lightbox.css">
    <link rel="stylesheet" href="css/whatsapp-float.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Space Background -->
    <div class="space-bg"></div>
    
    <!-- Bootstrap Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark custom-navbar">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <span class="brand-icon">‚ö°</span>
                <span class="brand-text">TheBinary</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- Dynamic menu items will be inserted here -->
                </ul>
            </div>
        </div>
    </nav>

    <section class="project-detail">
        <div class="container">
            <div id="projectContent">
                <div class="loading">Loading project details...</div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="modern-footer">
        <div class="container">
            <!-- Footer Main Content -->
            <div class="footer-grid">
                <!-- Brand Section -->
                <div class="footer-brand">
                    <div class="footer-logo">
                        <span class="logo-icon">‚ö°</span>
                        <span class="logo-text">TheBinary</span>
                    </div>
                    <p class="footer-tagline">
                        Building futures with cutting-edge projects for students
                    </p>
                    <div class="footer-social">
                        <a href="https://wa.me/918839540925" class="social-link" aria-label="WhatsApp" target="_blank" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="mailto:ravinonline23@gmail.com" class="social-link" aria-label="Email" title="Email">
                            <i class="fas fa-envelope"></i>
                        </a>
                        <a href="https://github.com/ravin2313" class="social-link" aria-label="GitHub" target="_blank" title="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">üè† Home</a></li>
                        <li><a href="projects.html">üì¶ All Projects</a></li>
                        <li><a href="contact.html">üí¨ Contact Us</a></li>
                        <li><a href="student-login.html">üéì Student Login</a></li>
                        <li><a href="student-register.html">‚ú® Register</a></li>
                    </ul>
                </div>
                
                <!-- Categories -->
                <div class="footer-links">
                    <h4>Categories</h4>
                    <ul>
                        <li><a href="projects.html?category=College Project">üéì College Projects</a></li>
                        <li><a href="projects.html?category=School Project">üìñ School Projects</a></li>
                        <li><a href="projects.html?category=Website">üåê Websites</a></li>
                        <li><a href="projects.html?category=Mobile App">üì± Mobile Apps</a></li>
                        <li><a href="projects.html?category=AI/ML">ü§ñ AI/ML Projects</a></li>
                    </ul>
                </div>
                
                <!-- Contact Info -->
                <div class="footer-contact">
                    <h4>Get In Touch</h4>
                    <div class="contact-item">
                        <span class="contact-icon">üìß</span>
                        <div>
                            <p class="contact-label">Email</p>
                            <a href="mailto:ravinonline23@gmail.com">ravinonline23@gmail.com</a>
                        </div>
                    </div>
                    <div class="contact-item">
                        <span class="contact-icon">üì±</span>
                        <div>
                            <p class="contact-label">Phone</p>
                            <a href="tel:+918839540925">+91 8839540925</a>
                        </div>
                    </div>
                    <a href="https://wa.me/918839540925?text=Hi%2C%20I'm%20interested%20in%20TheBinary%20projects" class="footer-cta-btn" target="_blank">
                        üí¨ Chat on WhatsApp
                    </a>
                </div>
            </div>
            
            <!-- Footer Bottom -->
            <div class="footer-bottom">
                <p>&copy; 2026 TheBinary. All rights reserved.</p>
                <p class="footer-love">Made with ‚ù§Ô∏è for Students</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/lightbox.js"></script>
    <script src="js/navbar-manager.js"></script>
    <script src="js/main.js"></script>
    <script src="js/student.js"></script>
    <script src="js/space-background.js"></script>
    <script src="js/animations.js"></script>
    <script src="js/whatsapp-float.js"></script>
    <script>
        let projectId = null; // Global variable
        
        async function loadProjectDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id'); // Set global variable
            
            if (!projectId) {
                window.location.href = 'projects.html';
                return;
            }
            
            try {
                const response = await fetch(`/api/projects/${projectId}`);
                const project = await response.json();
                
                // Increment view count
                fetch(`/api/projects/${projectId}/view`, { method: 'POST' })
                    .catch(err => console.log('View count error:', err));
                
                displayProjectDetail(project);
            } catch (error) {
                document.getElementById('projectContent').innerHTML = 
                    '<p class="error">Error loading project. Please try again.</p>';
                console.error('Error loading project:', error);
            }
        }

        function displayProjectDetail(project) {
            // Store images globally for gallery functions
            projectImages = project.images || [];
            
            const avgRating = project.reviews.length > 0 
                ? (project.reviews.reduce((sum, r) => sum + r.rating, 0) / project.reviews.length).toFixed(1)
                : 'No ratings yet';
            
            document.getElementById('projectContent').innerHTML = `
                <div class="detail-header">
                    <a href="projects.html" class="back-link">‚Üê Back to Projects</a>
                    <span class="project-category">${project.category}</span>
                </div>
                
                <h1>${project.title}</h1>
                
                <div class="detail-grid">
                    <div class="detail-main">
                        <!-- Enhanced Image Gallery -->
                        <div class="project-images-gallery ${project.images.length === 1 ? 'gallery-single' : 'gallery-multiple'}">
                            ${project.images.length === 1 ? `
                                <!-- Single Image -->
                                <div class="gallery-main" onclick="openLightbox(0)">
                                    <img src="${project.images[0]}" alt="${project.title}">
                                    <div class="zoom-icon">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                </div>
                            ` : `
                                <!-- Multiple Images -->
                                <div class="gallery-main" onclick="openLightbox(0)">
                                    <img src="${project.images[0]}" alt="${project.title}" id="mainImage">
                                    <div class="zoom-icon">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                    <div class="image-counter">
                                        <i class="fas fa-images"></i>
                                        <span id="currentImageIndex">1</span> / ${project.images.length}
                                    </div>
                                </div>
                                <div class="gallery-thumbnails">
                                    ${project.images.map((img, i) => `
                                        <div class="gallery-thumb ${i === 0 ? 'active' : ''}" 
                                             onclick="changeMainImage(${i})"
                                             data-index="${i}">
                                            <img src="${img}" alt="${project.title} ${i+1}">
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <!-- Lightbox Modal -->
                        <div class="lightbox-modal" id="lightboxModal" onclick="closeLightbox(event)">
                            <div class="lightbox-content">
                                <button class="lightbox-close" onclick="closeLightbox(event)">
                                    <i class="fas fa-times"></i>
                                </button>
                                ${project.images.length > 1 ? `
                                    <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1, event)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1, event)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                ` : ''}
                                <img src="${project.images[0]}" alt="${project.title}" class="lightbox-image" id="lightboxImage">
                                ${project.images.length > 1 ? `
                                    <div class="lightbox-counter">
                                        <span id="lightboxCounter">1</span> / ${project.images.length}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h2>Description</h2>
                            <p>${project.description}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h2>Features</h2>
                            <ul class="features-list">
                                ${project.features.map(f => `<li>‚úì ${f}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="detail-section">
                            <h2>Technologies Used</h2>
                            <div class="tech-tags">
                                ${project.technologies.map(t => 
                                    `<span class="tech-tag">${t}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        ${project.demoLink ? `
                            <div class="detail-section">
                                <h2>Demo</h2>
                                <a href="${project.demoLink}" target="_blank" class="btn btn-secondary">
                                    View Live Demo
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <h2>Student Reviews (${project.reviews.length})</h2>
                            
                            <!-- Add Review Form -->
                            <div class="review-form">
                                <h3>Write a Review</h3>
                                <div id="reviewFormContent">
                                    <form id="reviewForm">
                                        <div class="form-group">
                                            <label>Rating *</label>
                                            <div class="rating-stars">
                                                <span class="star" data-rating="1">‚òÖ</span>
                                                <span class="star" data-rating="2">‚òÖ</span>
                                                <span class="star" data-rating="3">‚òÖ</span>
                                                <span class="star" data-rating="4">‚òÖ</span>
                                                <span class="star" data-rating="5">‚òÖ</span>
                                            </div>
                                            <input type="hidden" name="rating" id="ratingValue" required>
                                            <small id="ratingError" style="color: red; display: none;">Please select a rating</small>
                                        </div>
                                        <div class="form-group">
                                            <label>Your Review *</label>
                                            <textarea name="comment" rows="4" required 
                                                placeholder="Share your experience with this project..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit Review</button>
                                    </form>
                                    <div id="reviewMessage" class="form-message"></div>
                                </div>
                            </div>
                            
                            <!-- Reviews List -->
                            <div class="reviews">
                                ${project.reviews.length > 0 ? project.reviews.map(review => `
                                    <div class="review-card">
                                        <div class="review-header">
                                            <strong>${review.studentName}</strong>
                                            <span class="rating">${'‚≠ê'.repeat(review.rating)}</span>
                                        </div>
                                        <p>${review.comment}</p>
                                        <small>${new Date(review.date).toLocaleDateString('hi-IN')}</small>
                                    </div>
                                `).join('') : '<p>No reviews yet. Be the first to review!</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-sidebar">
                        <div class="price-card">
                            <h3>Price</h3>
                            <div class="price">‚Çπ${project.price}</div>
                            <div class="rating-info">
                                <span>Rating: ${avgRating}</span>
                                <span>${project.reviews.length} reviews</span>
                            </div>
                            <button class="wishlist-btn" data-project-id="${project._id}" 
                                    onclick="addToWishlist('${project._id}')">
                                ü§ç Add to Wishlist
                            </button>
                            <a href="contact.html?project=${project._id}&title=${encodeURIComponent(project.title)}" 
                               class="btn btn-primary btn-block">
                                Contact for This Project
                            </a>
                            <div class="contact-options">
                                <p><strong>Or contact directly:</strong></p>
                                <a href="https://wa.me/918839540925?text=Hi%2C%20I'm%20interested%20in%20${encodeURIComponent(project.title)}" 
                                   class="btn btn-whatsapp btn-block" target="_blank">
                                    üì± WhatsApp
                                </a>
                                <a href="tel:+918839540925" class="btn btn-secondary btn-block">
                                    üìû Call Now
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize star rating
            const stars = document.querySelectorAll('.rating-stars .star');
            const ratingInput = document.getElementById('ratingValue');
            let selectedRating = 0;
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    ratingInput.value = selectedRating;
                    document.getElementById('ratingError').style.display = 'none';
                    
                    // Update star display
                    stars.forEach((s, index) => {
                        if (index < selectedRating) {
                            s.classList.add('selected');
                        } else {
                            s.classList.remove('selected');
                        }
                    });
                });
                
                // Hover effect
                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.getAttribute('data-rating'));
                    stars.forEach((s, index) => {
                        if (index < hoverRating) {
                            s.classList.add('hover');
                        } else {
                            s.classList.remove('hover');
                        }
                    });
                });
            });
            
            // Remove hover effect when mouse leaves
            document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                stars.forEach(s => s.classList.remove('hover'));
            });
            
            // Handle review form submission
            const reviewForm = document.getElementById('reviewForm');
            if (reviewForm) {
                reviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Check if rating is selected
                    if (!ratingInput.value) {
                        document.getElementById('ratingError').style.display = 'block';
                        return;
                    }
                    
                    // Check if user is logged in
                    if (!isUserLoggedIn()) {
                        if (confirm('Please login to post a review. Login now?')) {
                            window.location.href = 'student-login.html';
                        }
                        return;
                    }
                    
                    const formData = new FormData(e.target);
                    const rating = parseInt(ratingInput.value);
                    const comment = formData.get('comment');
                    
                    const messageDiv = document.getElementById('reviewMessage');
                    messageDiv.textContent = 'Posting review...';
                    messageDiv.className = 'form-message';
                    
                    try {
                        const token = localStorage.getItem('userToken');
                        
                        console.log('Submitting review:', {
                            projectId,
                            rating,
                            comment,
                            hasToken: !!token
                        });
                        
                        const response = await fetch(`/api/projects/${projectId}/review`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ rating, comment })
                        });
                        
                        const result = await response.json();
                        
                        console.log('Review response:', {
                            status: response.status,
                            ok: response.ok,
                            result
                        });
                        
                        if (response.ok) {
                            messageDiv.textContent = 'Review posted successfully! Refreshing...';
                            messageDiv.className = 'form-message success';
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            messageDiv.textContent = result.message || 'Failed to post review';
                            messageDiv.className = 'form-message error';
                        }
                    } catch (error) {
                        console.error('Review submission error:', error);
                        messageDiv.textContent = 'Error posting review. Please try again.';
                        messageDiv.className = 'form-message error';
                    }
                });
            }
        }
        
        // Gallery Functions - Use Premium Lightbox
        let currentImageIndex = 0;
        let projectImages = [];
        
        function changeMainImage(index) {
            currentImageIndex = index;
            const mainImage = document.getElementById('mainImage');
            const counter = document.getElementById('currentImageIndex');
            const thumbs = document.querySelectorAll('.gallery-thumb');
            
            if (mainImage && projectImages[index]) {
                mainImage.src = projectImages[index];
                if (counter) counter.textContent = index + 1;
                
                // Update active thumbnail
                thumbs.forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                });
            }
        }
        
        function openLightbox(index) {
            // Use premium lightbox
            if (projectImages.length > 0) {
                lightbox.open(projectImages, index);
            }
        }
        
        function closeLightbox(event) {
            // Kept for backward compatibility
            lightbox.close();
        }
        
        function navigateLightbox(direction, event) {
            // Kept for backward compatibility
            if (direction > 0) {
                lightbox.next();
            } else {
                lightbox.prev();
            }
        }

        loadProjectDetail();
    </script>
</body>
</html>
