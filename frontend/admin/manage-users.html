<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - TheBinary Admin</title>
    <link rel="stylesheet" href="../css/modern-theme.css">
    <link rel="stylesheet" href="../css/space-background.css">
    <link rel="stylesheet" href="../css/admin-panel.css">
</head>
<body>
    <!-- Space Background -->
    <div class="space-bg"></div>
    
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
    
    <div class="admin-layout">
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-logo">
                <h2>‚ö° Admin Panel</h2>
            </div>
            <nav class="admin-nav">
                <a href="dashboard.html">Dashboard</a>
                <a href="manage-projects.html">Manage Projects</a>
                <a href="manage-users.html" class="active">Manage Users</a>
                <a href="manage-contacts.html">Manage Contacts</a>
                <a href="manage-reviews.html">Manage Reviews</a>
                <a href="analytics.html">Analytics</a>
                <a href="settings.html">Settings</a>
                <a href="#" onclick="logout()">Logout</a>
            </nav>
        </aside>
        
        <main class="admin-main">
            <header class="admin-header">
                <h1>Manage Users</h1>
            </header>
            
            <div class="admin-content">
                <!-- Search & Filter -->
                <div class="admin-section">
                    <div class="search-filter-bar">
                        <input type="text" id="searchInput" placeholder="Search by name, email, or phone..." 
                            onkeyup="filterUsers()">
                        <select id="statusFilter" onchange="filterUsers()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="stat-number" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Users</h3>
                        <div class="stat-number" id="activeUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>New This Month</h3>
                        <div class="stat-number" id="newUsers">0</div>
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="admin-section">
                    <div id="usersList" class="users-list">
                        <div class="loading">Loading users...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/admin.js"></script>
    <script src="../js/space-background.js"></script>
    <script>
        checkAuth();
        
        let allUsers = [];
        
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            sidebar.classList.toggle('active');
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('adminSidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) &&
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
        
        async function loadUsers() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                allUsers = await response.json();
                updateStats();
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = 
                    '<p class="error">Error loading users. Please try again.</p>';
            }
        }
        
        function updateStats() {
            document.getElementById('totalUsers').textContent = allUsers.length;
            
            const activeCount = allUsers.filter(u => u.status === 'active').length;
            document.getElementById('activeUsers').textContent = activeCount;
            
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const newCount = allUsers.filter(u => new Date(u.createdAt) >= thisMonth).length;
            document.getElementById('newUsers').textContent = newCount;
        }
        
        function displayUsers(users) {
            const list = document.getElementById('usersList');
            
            if (users.length === 0) {
                list.innerHTML = '<p>No users found.</p>';
                return;
            }
            
            list.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>College/School</th>
                            <th>Registered</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.name}</strong></td>
                                <td>${user.email}</td>
                                <td>${user.phone || 'N/A'}</td>
                                <td>${user.college || user.school || 'N/A'}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString('hi-IN')}</td>
                                <td>
                                    <span class="status-badge status-${user.status || 'active'}">
                                        ${user.status || 'active'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn-icon" onclick="viewUser('${user._id}')" title="View Details">üëÅÔ∏è</button>
                                    <button class="btn-icon" onclick="resetPassword('${user._id}', '${user.name}')" title="Reset Password">üîë</button>
                                    <button class="btn-icon" onclick="toggleUserStatus('${user._id}', '${user.status || 'active'}')" 
                                        title="${user.status === 'active' ? 'Deactivate' : 'Activate'}">
                                        ${user.status === 'active' ? 'üîí' : 'üîì'}
                                    </button>
                                    <button class="btn-icon" onclick="deleteUser('${user._id}')" title="Delete">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allUsers;
            
            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.phone && user.phone.includes(searchTerm))
                );
            }
            
            // Status filter
            if (statusFilter) {
                filtered = filtered.filter(user => (user.status || 'active') === statusFilter);
            }
            
            displayUsers(filtered);
        }
        
        async function viewUser(id) {
            const user = allUsers.find(u => u._id === id);
            if (!user) return;
            
            alert(`User Details:\n\nName: ${user.name}\nEmail: ${user.email}\nPhone: ${user.phone || 'N/A'}\nCollege/School: ${user.college || user.school || 'N/A'}\nRegistered: ${new Date(user.createdAt).toLocaleString('hi-IN')}\nStatus: ${user.status || 'active'}`);
        }
        
        async function resetPassword(id, userName) {
            const newPassword = prompt(`Reset password for ${userName}\n\nEnter new password (minimum 6 characters):`);
            
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            if (!confirm(`Are you sure you want to reset password for ${userName}?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}/reset-password`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                if (response.ok) {
                    alert(`Password reset successfully for ${userName}!\n\nNew Password: ${newPassword}\n\nPlease share this with the user securely.`);
                } else {
                    alert('Error resetting password');
                }
            } catch (error) {
                alert('Error resetting password');
            }
        }
        
        async function toggleUserStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this user?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert('User status updated successfully!');
                    loadUsers();
                } else {
                    alert('Error updating user status');
                }
            } catch (error) {
                alert('Error updating user status');
            }
        }
        
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                alert('Error deleting user');
            }
        }
        
        loadUsers();
    </script>
</body>
</html>
